<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Homie's Hottest 100 – Top 50 Ranking</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      display: flex;
      justify-content: center;
      padding-top: 40px;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 14px;
      width: 900px;
      text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    h1 {
      color: #e65100;
      margin-bottom: 5px;
    }

    h2 {
      color: #ff7043;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .top-row {
      margin-bottom: 15px;
    }

    #nameInput {
      width: 30%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
    }

    .columns {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .column {
      flex: 1;
      background: #fff7f0;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }

    .column h3 {
      margin: 5px 0 10px 0;
      color: #bf360c;
    }

    .list-container {
      flex: 1;
      overflow-y: auto;
      max-height: 450px;
      padding-right: 4px;
    }

    .rank-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .rank-number {
      width: 28px;
      text-align: right;
      margin-right: 6px;
      font-weight: bold;
      color: #e65100;
    }

    .drop-slot {
      flex: 1;
      min-height: 56px;
      border-radius: 8px;
      background: #ffe9d6;
      border: 1px dashed #ffb74d;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
    }

    .drop-slot.empty {
      opacity: 0.7;
    }

    .song-card {
      background: #fff3e0;
      border: 1px solid #ffccbc;
      border-radius: 8px;
      padding: 6px 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      cursor: grab;
      font-size: 14px;
    }

    .song-card.dragging {
      opacity: 0.4;
    }

    .song-image {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 8px;
      background: #eee;
      flex-shrink: 0;
    }

    .song-text {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      overflow: hidden;
    }

    .song-title {
      font-weight: bold;
      color: #5d4037;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      width: 100%;
    }

    .song-artist {
      color: #8d6e63;
      font-size: 13px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      width: 100%;
    }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      margin-top: 20px;
      color: white;
    }

    .submit-btn {
      background: #1e88e5;
    }

    .note-text {
      margin-top: 10px;
      color: #6d4c41;
      font-size: 13px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Homie's Hottest 100</h1>
  <h2>Rank Your Top 50 – Drag from Right to Left</h2>

  <div class="top-row">
    <input id="nameInput" type="text" placeholder="Your Name">
  </div>

  <div class="columns">
    <!-- LEFT: Top 50 ranking -->
    <div class="column">
      <h3>Your Top 50 Ranking</h3>
      <div class="list-container" id="rankList">
        <!-- 1–50 rows generated by JS -->
      </div>
    </div>

    <!-- RIGHT: Full shortlist -->
    <div class="column">
      <h3>Shortlist</h3>
      <div class="list-container" id="shortlist">
        <!-- Songs loaded from /cleaned_songs -->
      </div>
    </div>
  </div>

  <button class="btn submit-btn" id="submitBtn">Submit Top 50</button>

  <p class="note-text">
    Drag songs from the right into the numbered slots on the left. You can reorder within the left list too.
  </p>

</div>

<script>
  // Ensure uniqueID exists
  if (!localStorage.getItem('uniqueID')) {
    localStorage.setItem('uniqueID', crypto.randomUUID());
  }
  const uniqueID = localStorage.getItem('uniqueID');

  const rankList = document.getElementById('rankList');
  const shortlistEl = document.getElementById('shortlist');
  const submitBtn = document.getElementById('submitBtn');

  let draggedCard = null;
  let draggedFrom = null; // 'shortlist' or 'rank'
  let rankState = Array(50).fill(null);

  // Create 1–50 slots
  function buildRankSlots() {
    for (let i = 1; i <= 50; i++) {
      const row = document.createElement('div');
      row.className = 'rank-row';

      const num = document.createElement('div');
      num.className = 'rank-number';
      num.textContent = i;

      const slot = document.createElement('div');
      slot.className = 'drop-slot empty';
      slot.dataset.index = i - 1;

      slot.addEventListener('dragover', e => {
        e.preventDefault();
      });

      slot.addEventListener('drop', e => {
        e.preventDefault();
        if (!draggedCard) return;
        placeCardInSlot(draggedCard, slot);
      });

      row.appendChild(num);
      row.appendChild(slot);
      rankList.appendChild(row);
    }
  }

  function createSongCard(songObj) {
    const card = document.createElement('div');
    card.className = 'song-card';
    card.draggable = true;
    card.dataset.song = songObj.song;
    card.dataset.artist = songObj.artist;
    card.dataset.imageUrl = songObj.image_url || '';

    const img = document.createElement('img');
    img.className = 'song-image';
    img.src = songObj.image_url || '';
    img.alt = songObj.song;

    const textWrap = document.createElement('div');
    textWrap.className = 'song-text';

    const title = document.createElement('div');
    title.className = 'song-title';
    title.textContent = songObj.song;

    const artist = document.createElement('div');
    artist.className = 'song-artist';
    artist.textContent = songObj.artist;

    textWrap.appendChild(title);
    textWrap.appendChild(artist);

    card.appendChild(img);
    card.appendChild(textWrap);

    card.addEventListener('dragstart', e => {
      draggedCard = card;
      draggedFrom = card.parentElement.id === 'shortlist' ? 'shortlist' : 'rank';
      card.classList.add('dragging');
    });

    card.addEventListener('dragend', e => {
      card.classList.remove('dragging');
      draggedCard = null;
      draggedFrom = null;
    });

    return card;
  }

  function placeCardInSlot(card, slot) {
    const index = parseInt(slot.dataset.index, 10);
    const slots = Array.from(rankList.querySelectorAll('.drop-slot'));

    // Extract card data
    let songData = {
      song: card.dataset.song,
      artist: card.dataset.artist,
      image_url: card.dataset.imageUrl
    };

    // Remove card from its old position in rankState
    const oldIndex = rankState.findIndex(x =>
      x && x.song === songData.song && x.artist === songData.artist
    );
    if (oldIndex !== -1) rankState[oldIndex] = null;

    if (draggedFrom === 'shortlist') {
      card.remove();  // remove from shortlist immediately
    }

    let current = index;

    while (true) {
      if (rankState[current] === null) {
        rankState[current] = songData;
        break;
      }

      if (current === 49) {
        const bottom = rankState[49];
        rankState[49] = songData;

        const bottomCard = slots[49].querySelector('.song-card');
        if (bottomCard) shortlistEl.appendChild(bottomCard);

        break;
      }

      // Remove the occupying card from the DOM immediately
      const occupyingCard = slots[current].querySelector('.song-card');
      if (occupyingCard) occupyingCard.remove();

      const temp = rankState[current];
      rankState[current] = songData;
      songData = temp;
      current++;
    }

    renderRankList();
  }

  function renderRankList() {
    const slots = Array.from(rankList.querySelectorAll('.drop-slot'));

    for (let i = 0; i < 50; i++) {
      const slot = slots[i];
      slot.innerHTML = '';

      if (rankState[i] === null) {
        slot.classList.add('empty');
        continue;
      }

      slot.classList.remove('empty');
      slot.appendChild(createSongCard(rankState[i]));
    }
  }

  // Shortlist accepts drops only from rank (to "return" songs)
  shortlistEl.addEventListener('dragover', e => {
    e.preventDefault();
  });

  shortlistEl.addEventListener('drop', e => {
    e.preventDefault();
    if (!draggedCard) return;

    // If dragged from rank, free up that slot
    if (draggedFrom === 'rank') {
      const parentSlot = draggedCard.parentElement;
      if (parentSlot.classList.contains('drop-slot')) {
        const idx = parseInt(parentSlot.dataset.index, 10);
        rankState[idx] = null;
        parentSlot.innerHTML = '';
        parentSlot.classList.add('empty');
      }
    }

    shortlistEl.appendChild(draggedCard);
  });

  rankList.addEventListener('drop', e => {
    e.preventDefault();
    if (!draggedCard) return;

    const card = e.target.closest('.song-card');
    const slot = e.target.closest('.drop-slot');

    // If dropped on a card, treat it as dropping on that card's slot
    if (card) {
      const parentSlot = card.parentElement;
      placeCardInSlot(draggedCard, parentSlot);
      return;
    }

    // If dropped on an empty slot
    if (slot) {
      placeCardInSlot(draggedCard, slot);
    }
  });

  async function loadShortlist() {
    const response = await fetch('https://homies-hottest-100.onrender.com/cleaned_songs');
    const data = await response.json();

    data.forEach(songObj => {
      const card = createSongCard(songObj);
      shortlistEl.appendChild(card);
    });
  }

  submitBtn.onclick = async () => {
    const name = document.getElementById('nameInput').value.trim();
    if (!name) {
      alert('Please enter your name before submitting.');
      return;
    }

    const ranked = rankState.map(entry => entry ? {
      song: entry.song,
      artist: entry.artist,
      image_url: entry.image_url
    } : null);

    const response = await fetch('https://homies-hottest-100.onrender.com/submit_top50', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, uniqueID, ranked })
    });

    const result = await response.json();

    if (result.error === 'already_submitted') {
      alert('You have already submitted your Top 50.');
      return;
    }

    alert('Top 50 submitted!');
  };

  buildRankSlots();
  loadShortlist();
</script>

</body>
</html>